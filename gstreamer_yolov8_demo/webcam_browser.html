<!DOCTYPE html>
<!--
SPDX-FileCopyrightText: Â© 2025 Tenstorrent AI ULC
SPDX-License-Identifier: Apache-2.0

YOLOv8s Webcam Client - Browser-based
Opens webcam, sends frames to T3K, receives bbox, draws detections.

Usage: Open this file in browser, or serve via: python -m http.server 8000
-->
<html>
<head>
    <title>YOLOv8s Webcam - Tenstorrent</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2rem;
            font-weight: 600;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        .subtitle { color: #888; font-size: 0.9rem; }
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .video-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        #canvas {
            display: block;
            background: #000;
            border-radius: 12px;
        }
        #video { display: none; }
        .controls {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #00d4ff;
        }
        button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        #connectBtn {
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            color: #fff;
        }
        #connectBtn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,212,255,0.4); }
        #connectBtn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #disconnectBtn {
            background: rgba(255,50,50,0.2);
            color: #ff5555;
            border: 1px solid #ff5555;
            margin-top: 10px;
            display: none;
        }
        .stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stat-label { color: #888; }
        .stat-value { color: #00d4ff; font-weight: 600; font-family: 'SF Mono', monospace; }
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .status.disconnected { background: rgba(255,100,100,0.1); color: #ff6666; }
        .status.connecting { background: rgba(255,200,100,0.1); color: #ffcc66; }
        .status.connected { background: rgba(100,255,100,0.1); color: #66ff66; }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        .status.connecting .status-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>YOLOv8s Object Detection</h1>
            <p class="subtitle">Powered by Tenstorrent AI Accelerators</p>
        </header>
        
        <div class="main-content">
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" width="640" height="480"></canvas>
            </div>
            
            <div class="controls">
                <div id="status" class="status disconnected">
                    <span class="status-dot"></span>
                    <span id="statusText">Disconnected</span>
                </div>
                
                <div class="control-group">
                    <label>WebSocket Server</label>
                    <input type="text" id="serverUrl" value="ws://localhost:8765" placeholder="ws://T3K_IP:8765">
                </div>
                
                <button id="connectBtn" onclick="toggleConnection()">Start Detection</button>
                <button id="disconnectBtn" onclick="disconnect()">Stop</button>
                
                <div class="stats">
                    <div class="stat-row">
                        <span class="stat-label">Inference</span>
                        <span class="stat-value" id="inferenceTime">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">FPS</span>
                        <span class="stat-value" id="fps">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Detections</span>
                        <span class="stat-value" id="detections">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Round Trip</span>
                        <span class="stat-value" id="roundTrip">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const COCO_NAMES = [
            "person", "bicycle", "car", "motorcycle", "airplane", "bus", "train", "truck", "boat",
            "traffic light", "fire hydrant", "stop sign", "parking meter", "bench", "bird", "cat",
            "dog", "horse", "sheep", "cow", "elephant", "bear", "zebra", "giraffe", "backpack",
            "umbrella", "handbag", "tie", "suitcase", "frisbee", "skis", "snowboard", "sports ball",
            "kite", "baseball bat", "baseball glove", "skateboard", "surfboard", "tennis racket",
            "bottle", "wine glass", "cup", "fork", "knife", "spoon", "bowl", "banana", "apple",
            "sandwich", "orange", "broccoli", "carrot", "hot dog", "pizza", "donut", "cake", "chair",
            "couch", "potted plant", "bed", "dining table", "toilet", "tv", "laptop", "mouse",
            "remote", "keyboard", "cell phone", "microwave", "oven", "toaster", "sink", "refrigerator",
            "book", "clock", "vase", "scissors", "teddy bear", "hair drier", "toothbrush"
        ];
        
        const COLORS = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
        
        let video, canvas, ctx;
        let ws = null;
        let isRunning = false;
        let sendTime = 0;
        
        function init() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
        }
        
        function setStatus(state, text) {
            const el = document.getElementById('status');
            el.className = 'status ' + state;
            document.getElementById('statusText').textContent = text;
        }
        
        async function toggleConnection() {
            if (isRunning) return;
            
            const serverUrl = document.getElementById('serverUrl').value;
            setStatus('connecting', 'Starting webcam...');
            
            try {
                // Start webcam
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
                await video.play();
                
                // Connect WebSocket
                setStatus('connecting', 'Connecting to server...');
                ws = new WebSocket(serverUrl);
                
                ws.onopen = () => {
                    setStatus('connected', 'Connected - Running');
                    isRunning = true;
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('disconnectBtn').style.display = 'block';
                    sendFrame();
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const roundTrip = Date.now() - sendTime;
                    
                    // Update stats
                    document.getElementById('inferenceTime').textContent = data.inference_ms.toFixed(1) + ' ms';
                    document.getElementById('fps').textContent = (1000 / data.inference_ms).toFixed(0);
                    document.getElementById('detections').textContent = data.count;
                    document.getElementById('roundTrip').textContent = roundTrip + ' ms';
                    
                    // Draw frame with detections
                    drawFrame(data.detections);
                    
                    // Send next frame
                    if (isRunning) {
                        requestAnimationFrame(sendFrame);
                    }
                };
                
                ws.onerror = (err) => {
                    console.error('WebSocket error:', err);
                    setStatus('disconnected', 'Connection error');
                    disconnect();
                };
                
                ws.onclose = () => {
                    if (isRunning) {
                        setStatus('disconnected', 'Connection closed');
                        disconnect();
                    }
                };
                
            } catch (err) {
                console.error('Error:', err);
                setStatus('disconnected', 'Error: ' + err.message);
            }
        }
        
        function disconnect() {
            isRunning = false;
            if (ws) {
                ws.close();
                ws = null;
            }
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }
            setStatus('disconnected', 'Disconnected');
            document.getElementById('connectBtn').style.display = 'block';
            document.getElementById('disconnectBtn').style.display = 'none';
        }
        
        function sendFrame() {
            if (!isRunning || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            // Draw video to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get JPEG data
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    sendTime = Date.now();
                    ws.send(JSON.stringify({ frame: base64 }));
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.8);
        }
        
        function drawFrame(detections) {
            // Draw current video frame
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Draw detections
            ctx.lineWidth = 2;
            ctx.font = '14px SF Pro Display, sans-serif';
            
            for (const det of detections) {
                const color = COLORS[det.class_id % COLORS.length];
                const label = `${COCO_NAMES[det.class_id]}: ${(det.confidence * 100).toFixed(0)}%`;
                
                // Scale from 640x640 to canvas size
                const x1 = det.x1 * canvas.width / 640;
                const y1 = det.y1 * canvas.height / 640;
                const x2 = det.x2 * canvas.width / 640;
                const y2 = det.y2 * canvas.height / 640;
                
                // Draw box
                ctx.strokeStyle = color;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // Draw label background
                const textWidth = ctx.measureText(label).width;
                ctx.fillStyle = color;
                ctx.fillRect(x1, y1 - 20, textWidth + 10, 20);
                
                // Draw label text
                ctx.fillStyle = '#000';
                ctx.fillText(label, x1 + 5, y1 - 5);
            }
        }
        
        window.onload = init;
    </script>
</body>
</html>
