name: Test Gate
on:
  workflow_dispatch:
  pull_request:
    branches: ["main", "dev"]
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**/requirements*.txt'
      - 'pyproject.toml'

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/tt-media-server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements-dev.txt'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -r tt-media-server/requirements.txt
          pip install pytest-json-report

      #############################
      ## MAIN TESTS
      #############################
      - name: Run tt-inference-server tests
        run: |
          pytest tests/ \
            -v --tb=short --tb=line \
            --json-report --json-report-file=main_report.json \
            > main_output.txt 2>&1 || echo "MAIN_FAILED=true" >> $GITHUB_ENV

      #############################
      ## MEDIA TESTS
      #############################
      - name: Run tt-media-server tests
        working-directory: tt-media-server
        env:
          HF_TOKEN: ""
          MODEL: ""
          JWT_SECRET: ""
        run: |
          pytest tests/ \
            -v --tb=short --continue-on-collection-errors \
            --json-report --json-report-file=media_report.json \
            > ../media_output.txt 2>&1 || echo "MEDIA_FAILED=true" >> $GITHUB_ENV

      #############################
      ## Upload logs
      #############################
      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-logs
          path: |
            main_output.txt
            main_report.json
            media_output.txt
            tt-media-server/media_report.json

      #############################
      ## SUMMARY + FINAL STATUS
      #############################
      - name: Test Summary
        if: always()
        run: |
          echo "===== ðŸ§ª Test Summary =====" >> $GITHUB_STEP_SUMMARY

          parse_json () {
            FILE="$1"
            KEY="$2"
            python3 - <<EOF
import json
with open("$FILE") as f:
    data=json.load(f)
print(data.get("summary", {}).get("$KEY", 0))
EOF
          }

          # MAIN
          MAIN_PASSED=$(parse_json main_report.json passed)
          MAIN_FAILED_CNT=$(parse_json main_report.json failed)
          MAIN_ERRORS=$(parse_json main_report.json errors)
          MAIN_SKIPPED=$(parse_json main_report.json skipped)
          MAIN_COLLECTED=$(parse_json main_report.json collected)
          MAIN_TOTAL=$MAIN_COLLECTED

          # MEDIA
          MEDIA_PASSED=$(parse_json tt-media-server/media_report.json passed)
          MEDIA_FAILED_CNT=$(parse_json tt-media-server/media_report.json failed)
          MEDIA_ERRORS=$(parse_json tt-media-server/media_report.json errors)
          MEDIA_SKIPPED=$(parse_json tt-media-server/media_report.json skipped)
          MEDIA_COLLECTED=$(parse_json tt-media-server/media_report.json collected)
          MEDIA_TOTAL=$MEDIA_COLLECTED

          # Overall
          TOTAL=$(($MAIN_TOTAL + $MEDIA_TOTAL))
          PASSED=$(($MAIN_PASSED + $MEDIA_PASSED))
          FAILED=$(($MAIN_FAILED_CNT + $MEDIA_FAILED_CNT + $MAIN_ERRORS + $MEDIA_ERRORS))

          echo "### ðŸ§ª tt-inference-server" >> $GITHUB_STEP_SUMMARY
          echo "**Total:** $MAIN_TOTAL â€¢ **Passed:** $MAIN_PASSED â€¢ **Failed/Errors:** $(($MAIN_FAILED_CNT + $MAIN_ERRORS))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ§ª tt-media-server" >> $GITHUB_STEP_SUMMARY
          echo "**Total:** $MEDIA_TOTAL â€¢ **Passed:** $MEDIA_PASSED â€¢ **Failed/Errors:** $(($MEDIA_FAILED_CNT + $MEDIA_ERRORS))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“Š Overall Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Total tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… Passed:** $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "**âŒ Failed:** $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fail the job if either test suite failed
          if [ "$FAILED" -gt 0 ] || [ "${MAIN_FAILED:-false}" = "true" ] || [ "${MEDIA_FAILED:-false}" = "true" ]; then
            echo "Tests failed"
            exit 1
          fi

          echo "âœ… All tests passed"
