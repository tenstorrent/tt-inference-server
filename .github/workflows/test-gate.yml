name: Test Gate
on:
  workflow_dispatch:
  pull_request:
    branches: ["main", "dev"]
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**/requirements*.txt'
      - 'pyproject.toml'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/tt-media-server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements-dev.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -r tt-media-server/requirements.txt

      - name: Run tt-inference-server tests
        run: |
          echo "Running tests from tests/ directory..."
          pytest tests/ -v --tb=short --tb=line > main_test_output.txt 2>&1 || echo "MAIN_TESTS_FAILED=true" >> $GITHUB_ENV

          if grep -q "FAILED" main_test_output.txt; then
            echo "MAIN_TESTS_FAILED=true" >> $GITHUB_ENV
          fi

          # Safe numeric extraction
          MAIN_PASSED=$(grep -o "[0-9]\+ passed" main_test_output.txt | grep -o "[0-9]\+" | tr -dc '0-9' || echo "0")
          MAIN_FAILED=$(grep -o "[0-9]\+ failed" main_test_output.txt | grep -o "[0-9]\+" | tr -dc '0-9' || echo "0")
          MAIN_ERRORS=$(grep -o "[0-9]\+ error" main_test_output.txt | grep -o "[0-9]\+" | tr -dc '0-9' || echo "0")

          echo "MAIN_PASSED=$MAIN_PASSED" >> $GITHUB_ENV
          echo "MAIN_FAILED=$MAIN_FAILED" >> $GITHUB_ENV
          echo "MAIN_ERRORS=$MAIN_ERRORS" >> $GITHUB_ENV

          cat main_test_output.txt

          if [ "$MAIN_TESTS_FAILED" = "true" ]; then exit 1; fi

      - name: Run tt-media-server tests
        env:
          HF_TOKEN: ""
          MODEL: ""
          JWT_SECRET: ""
        working-directory: tt-media-server
        run: |
          echo "Running tests from tt-media-server/tests/"
          pytest tests/ -v --tb=short --continue-on-collection-errors > ../media_test_output.txt 2>&1 || echo "MEDIA_TESTS_FAILED=true" >> $GITHUB_ENV

          if grep -q "FAILED" ../media_test_output.txt; then
            echo "MEDIA_TESTS_FAILED=true" >> $GITHUB_ENV
          fi

          # Safe numeric extraction
          MEDIA_PASSED=$(grep -o "[0-9]\+ passed" ../media_test_output.txt | grep -o "[0-9]\+" | tr -dc '0-9' || echo "0")
          MEDIA_FAILED=$(grep -o "[0-9]\+ failed" ../media_test_output.txt | grep -o "[0-9]\+" | tr -dc '0-9' || echo "0")
          MEDIA_ERRORS=$(grep -o "[0-9]\+ error" ../media_test_output.txt | grep -o "[0-9]\+" | tr -dc '0-9' || echo "0")
          MEDIA_COLLECTED=$(grep -o "[0-9]\+ tests collected" ../media_test_output.txt | grep -o "[0-9]\+" | tr -dc '0-9' || echo "0")

          # Collection errors
          MEDIA_COLLECTION_ERRORS=$(grep -o "[0-9]\+ tests collected / [0-9]\+ errors" ../media_test_output.txt \
              | grep -o "/ [0-9]\+ errors" \
              | grep -o "[0-9]\+" \
              | tr -dc '0-9' \
              || echo "0")

          echo "MEDIA_PASSED=$MEDIA_PASSED" >> $GITHUB_ENV
          echo "MEDIA_FAILED=$MEDIA_FAILED" >> $GITHUB_ENV
          echo "MEDIA_ERRORS=$MEDIA_ERRORS" >> $GITHUB_ENV
          echo "MEDIA_COLLECTED=$MEDIA_COLLECTED" >> $GITHUB_ENV
          echo "MEDIA_COLLECTION_ERRORS=$MEDIA_COLLECTION_ERRORS" >> $GITHUB_ENV

          cat ../media_test_output.txt

          if [ "$MEDIA_TESTS_FAILED" = "true" ]; then exit 1; fi

      - name: Test Results Summary
        if: always()
        run: |
          echo "===== ðŸ§ª Test Results Summary ====="
          echo "===== ðŸ§ª Test Results Summary =====" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY

          # MAIN totals
          MAIN_TOTAL_FAILED=$((MAIN_FAILED + MAIN_ERRORS))
          MAIN_TOTAL=$((MAIN_PASSED + MAIN_TOTAL_FAILED))

          # MEDIA totals
          MEDIA_TOTAL_FAILED=$((MEDIA_FAILED + MEDIA_ERRORS + MEDIA_COLLECTION_ERRORS))
          MEDIA_TOTAL=$((MEDIA_PASSED + MEDIA_TOTAL_FAILED))

          # Overall totals
          TOTAL_TESTS=$((MAIN_TOTAL + MEDIA_TOTAL))
          TOTAL_PASSED=$((MAIN_PASSED + MEDIA_PASSED))
          TOTAL_FAILED=$((MAIN_TOTAL_FAILED + MEDIA_TOTAL_FAILED))

          # MAIN summary
          if [ "$MAIN_TESTS_FAILED" = "true" ] || [ "$MAIN_TOTAL_FAILED" -gt 0 ]; then
            echo "âŒ tt-inference-server tests: $MAIN_TOTAL total, $MAIN_PASSED passed, $MAIN_TOTAL_FAILED failed"
            echo "âŒ tt-inference-server tests: $MAIN_TOTAL total, $MAIN_PASSED passed, $MAIN_TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… tt-inference-server tests: $MAIN_TOTAL total, $MAIN_PASSED passed, 0 failed"
            echo "âœ… tt-inference-server tests: $MAIN_TOTAL total, $MAIN_PASSED passed, 0 failed" >> $GITHUB_STEP_SUMMARY
          fi

          # MEDIA summary
          if [ "$MEDIA_TESTS_FAILED" = "true" ] || [ "$MEDIA_TOTAL_FAILED" -gt 0 ]; then
            echo "âŒ tt-media-server tests: $MEDIA_TOTAL total, $MEDIA_PASSED passed, $MEDIA_TOTAL_FAILED failed"
            echo "âŒ tt-media-server tests: $MEDIA_TOTAL total, $MEDIA_PASSED passed, $MEDIA_TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… tt-media-server tests: $MEDIA_TOTAL total, $MEDIA_PASSED passed, 0 failed"
            echo "âœ… tt-media-server tests: $MEDIA_TOTAL total, $MEDIA_PASSED passed, 0 failed" >> $GITHUB_STEP_SUMMARY
          fi

          # OVERALL summary
          echo "ðŸ“Š Overall: $TOTAL_TESTS total tests, $TOTAL_PASSED passed, $TOTAL_FAILED failed"
          echo "ðŸ“Š Overall: $TOTAL_TESTS total tests, $TOTAL_PASSED passed, $TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY

          if [ "$MAIN_TESTS_FAILED" = "true" ] || [ "$MEDIA_TESTS_FAILED" = "true" ]; then
            echo "âŒ Some tests failed - PR merge will be blocked"
            echo "âŒ Some tests failed - PR merge will be blocked" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All tests passed - PR is ready for review"
            echo "âœ… All tests passed - PR is ready for review" >> $GITHUB_STEP_SUMMARY
          fi
