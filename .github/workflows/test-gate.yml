name: Test Gate
on:
  workflow_dispatch:
  pull_request:
    branches: ["main", "dev"]
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**/requirements*.txt'
      - 'pyproject.toml'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements-dev.txt'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -r tt-media-server/requirements.txt
      - name: Run tt-inference-server tests
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/tt-media-server
        run: |
          echo "Running tests from tests/ directory..."
          pytest tests/ -v --tb=short --tb=line > main_test_output.txt 2>&1 || echo "MAIN_TESTS_FAILED=true" >> $GITHUB_ENV

          # Extract test results
          if grep -q "FAILED" main_test_output.txt; then
            echo "MAIN_TESTS_FAILED=true" >> $GITHUB_ENV
          fi

          # Count passed and failed tests
          MAIN_PASSED=$(grep -o "[0-9]\+ passed" main_test_output.txt | grep -o "[0-9]\+" || echo "0")
          MAIN_FAILED=$(grep -o "[0-9]\+ failed" main_test_output.txt | grep -o "[0-9]\+" || echo "0")

          echo "MAIN_PASSED=$MAIN_PASSED" >> $GITHUB_ENV
          echo "MAIN_FAILED=$MAIN_FAILED" >> $GITHUB_ENV

          # Show output
          cat main_test_output.txt

          # Fail this step if tests failed
          if [ "$MAIN_TESTS_FAILED" = "true" ]; then
            exit 1
          fi
      - name: Run tt-media-server tests
        env:
          PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/tt-media-server
          HF_TOKEN: ""
          MODEL: ""
          JWT_SECRET: ""
        working-directory: tt-media-server
        run: |
          echo "Running tests from tt-media-server/tests/ directory..."
          # Add current directory to Python path to fix imports
          export PYTHONPATH=".:$PYTHONPATH"
          pytest tests/ -v --tb=short > ../media_test_output.txt 2>&1 || echo "MEDIA_TESTS_FAILED=true" >> $GITHUB_ENV

          # Extract test results
          if grep -q "FAILED" ../media_test_output.txt; then
            echo "MEDIA_TESTS_FAILED=true" >> $GITHUB_ENV
          fi

          # Count passed and failed tests
          MEDIA_PASSED=$(grep -o "[0-9]\+ passed" ../media_test_output.txt | grep -o "[0-9]\+" || echo "0")
          MEDIA_FAILED=$(grep -o "[0-9]\+ failed" ../media_test_output.txt | grep -o "[0-9]\+" || echo "0")
          MEDIA_ERRORS=$(grep -o "[0-9]\+ error" ../media_test_output.txt | grep -o "[0-9]\+" || echo "0")

          echo "MEDIA_PASSED=$MEDIA_PASSED" >> $GITHUB_ENV
          echo "MEDIA_FAILED=$MEDIA_FAILED" >> $GITHUB_ENV
          echo "MEDIA_ERRORS=$MEDIA_ERRORS" >> $GITHUB_ENV

          # Show output
          cat ../media_test_output.txt

          # Fail this step if tests failed
          if [ "$MEDIA_TESTS_FAILED" = "true" ]; then
            exit 1
          fi
      - name: Test Results Summary
        if: always()
        run: |
          echo "===== üß™ Test Results Summary ====="
          printf "\n"

          # Main tests summary
          if [ "$MAIN_TESTS_FAILED" = "true" ] || [ "${MAIN_FAILED:-0}" -gt 0 ]; then
            echo "‚ùå tt-inference-server tests: ${MAIN_PASSED:-0} passed, ${MAIN_FAILED:-0} failed"
          else
            echo "‚úÖ tt-inference-server tests: ${MAIN_PASSED:-0} passed, ${MAIN_FAILED:-0} failed"
          fi

          # Media server tests summary
          MEDIA_TOTAL_FAILED=$((${MEDIA_FAILED:-0} + ${MEDIA_ERRORS:-0}))
          if [ "$MEDIA_TESTS_FAILED" = "true" ] || [ "${MEDIA_FAILED:-0}" -gt 0 ] || [ "${MEDIA_ERRORS:-0}" -gt 0 ]; then
            echo "‚ùå tt-media-server tests: ${MEDIA_PASSED:-0} passed, $MEDIA_TOTAL_FAILED failed"
          else
            echo "‚úÖ tt-media-server tests: ${MEDIA_PASSED:-0} passed, $MEDIA_TOTAL_FAILED failed"
          fi

          printf "\n"
          echo "üìä Check the job logs above for detailed results"
          printf "\n"

          # Report overall status
          if [ "$MAIN_TESTS_FAILED" = "true" ] || [ "$MEDIA_TESTS_FAILED" = "true" ]; then
            echo "‚ùå Some tests failed - PR merge will be blocked"
          else
            echo "‚úÖ All tests passed - PR is ready for review"
          fi
