name: Test Gate
on:
  workflow_dispatch:
  pull_request:
    branches: ["main", "dev"]
    types: [opened, synchronize, reopened]
    paths:
      - '**.py'
      - '**/requirements*.txt'
      - 'pyproject.toml'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/tt-media-server
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'requirements-dev.txt'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -r tt-media-server/requirements.txt
      - name: Run tt-inference-server tests
        run: |
          echo "Running tests from tests/ directory..."
          pytest tests/ -v --tb=short --tb=line > main_test_output.txt 2>&1 || echo "MAIN_TESTS_FAILED=true" >> $GITHUB_ENV

          # Extract test results
          if grep -q "FAILED" main_test_output.txt; then
            echo "MAIN_TESTS_FAILED=true" >> $GITHUB_ENV
          fi

          # Count passed and failed tests
          MAIN_PASSED=$(grep -o "[0-9]\+ passed" main_test_output.txt | grep -o "[0-9]\+" || echo "0")
          MAIN_FAILED=$(grep -o "[0-9]\+ failed" main_test_output.txt | grep -o "[0-9]\+" || echo "0")
          MAIN_ERRORS=$(grep -o "[0-9]\+ error" main_test_output.txt | grep -o "[0-9]\+" || echo "0")

          echo "MAIN_PASSED=$MAIN_PASSED" >> $GITHUB_ENV
          echo "MAIN_FAILED=$MAIN_FAILED" >> $GITHUB_ENV
          echo "MAIN_ERRORS=$MAIN_ERRORS" >> $GITHUB_ENV

          # Show output
          cat main_test_output.txt

          # Fail this step if tests failed
          if [ "$MAIN_TESTS_FAILED" = "true" ]; then
            exit 1
          fi
      - name: Run tt-media-server tests
        env:
          HF_TOKEN: ""
          MODEL: ""
          JWT_SECRET: ""
        working-directory: tt-media-server
        run: |
          echo "Running tests from tt-media-server/tests/ directory..."
          pytest tests/ -v --tb=short > ../media_test_output.txt 2>&1 || echo "MEDIA_TESTS_FAILED=true" >> $GITHUB_ENV

          # Extract test results
          if grep -q "FAILED" ../media_test_output.txt; then
            echo "MEDIA_TESTS_FAILED=true" >> $GITHUB_ENV
          fi

          # Count passed and failed tests
          MEDIA_PASSED=$(grep -o "[0-9]\+ passed" ../media_test_output.txt | grep -o "[0-9]\+" || echo "0")
          MEDIA_FAILED=$(grep -o "[0-9]\+ failed" ../media_test_output.txt | grep -o "[0-9]\+" || echo "0")
          MEDIA_ERRORS=$(grep -o "[0-9]\+ error" ../media_test_output.txt | grep -o "[0-9]\+" || echo "0")

          echo "MEDIA_PASSED=$MEDIA_PASSED" >> $GITHUB_ENV
          echo "MEDIA_FAILED=$MEDIA_FAILED" >> $GITHUB_ENV
          echo "MEDIA_ERRORS=$MEDIA_ERRORS" >> $GITHUB_ENV

          # Show output
          cat ../media_test_output.txt

          # Fail this step if tests failed
          if [ "$MEDIA_TESTS_FAILED" = "true" ]; then
            exit 1
          fi
      - name: Test Results Summary
        if: always()
        run: |
          echo "===== ðŸ§ª Test Results Summary ====="
          echo "===== ðŸ§ª Test Results Summary =====" >> $GITHUB_STEP_SUMMARY
          echo
          echo >> $GITHUB_STEP_SUMMARY

          # Calculate totals
          MAIN_TOTAL_FAILED=$((${MAIN_FAILED:-0} + ${MAIN_ERRORS:-0}))
          MAIN_TOTAL=$((${MAIN_PASSED:-0} + $MAIN_TOTAL_FAILED))
          MEDIA_TOTAL_FAILED=$((${MEDIA_FAILED:-0} + ${MEDIA_ERRORS:-0}))
          MEDIA_TOTAL=$((${MEDIA_PASSED:-0} + $MEDIA_TOTAL_FAILED))

          TOTAL_TESTS=$((MAIN_TOTAL + MEDIA_TOTAL))
          TOTAL_PASSED=$((${MAIN_PASSED:-0} + ${MEDIA_PASSED:-0}))
          TOTAL_FAILED=$((MAIN_TOTAL_FAILED + MEDIA_TOTAL_FAILED))

          # Main tests summary
          if [ "$MAIN_TESTS_FAILED" = "true" ] || [ "${MAIN_FAILED:-0}" -gt 0 ] || [ "${MAIN_ERRORS:-0}" -gt 0 ]; then
            echo "âŒ tt-inference-server tests: $MAIN_TOTAL total, ${MAIN_PASSED:-0} passed, $MAIN_TOTAL_FAILED failed"
            echo "âŒ tt-inference-server tests: $MAIN_TOTAL total, ${MAIN_PASSED:-0} passed, $MAIN_TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… tt-inference-server tests: $MAIN_TOTAL total, ${MAIN_PASSED:-0} passed, $MAIN_TOTAL_FAILED failed"
            echo "âœ… tt-inference-server tests: $MAIN_TOTAL total, ${MAIN_PASSED:-0} passed, $MAIN_TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Media server tests summary
          if [ "$MEDIA_TESTS_FAILED" = "true" ] || [ "${MEDIA_FAILED:-0}" -gt 0 ] || [ "${MEDIA_ERRORS:-0}" -gt 0 ]; then
            echo "âŒ tt-media-server tests: $MEDIA_TOTAL total, ${MEDIA_PASSED:-0} passed, $MEDIA_TOTAL_FAILED failed"
            echo "âŒ tt-media-server tests: $MEDIA_TOTAL total, ${MEDIA_PASSED:-0} passed, $MEDIA_TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… tt-media-server tests: $MEDIA_TOTAL total, ${MEDIA_PASSED:-0} passed, $MEDIA_TOTAL_FAILED failed"
            echo "âœ… tt-media-server tests: $MEDIA_TOTAL total, ${MEDIA_PASSED:-0} passed, $MEDIA_TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ“Š Overall: $TOTAL_TESTS total tests, $TOTAL_PASSED passed, $TOTAL_FAILED failed"
          echo "ðŸ“Š Overall: $TOTAL_TESTS total tests, $TOTAL_PASSED passed, $TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY
          echo
          echo >> $GITHUB_STEP_SUMMARY

          # Report overall status
          if [ "$MAIN_TESTS_FAILED" = "true" ] || [ "$MEDIA_TESTS_FAILED" = "true" ]; then
            echo "âŒ Some tests failed - PR merge will be blocked"
            echo "âŒ Some tests failed - PR merge will be blocked" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All tests passed - PR is ready for review"
            echo "âœ… All tests passed - PR is ready for review" >> $GITHUB_STEP_SUMMARY
          fi
