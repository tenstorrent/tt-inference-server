# SPDX-License-Identifier: Apache-2.0
#
# SPDX-FileCopyrightText: Â© 2025 Tenstorrent AI ULC

# ==============================================================================
# BUILDER STAGE - build tt-xla and vLLM plugin
# ==============================================================================
ARG TT_XLA_BASE_IMAGE_TAG="latest"
FROM ghcr.io/tenstorrent/tt-xla/tt-xla-ird-ubuntu-22-04:${TT_XLA_BASE_IMAGE_TAG} AS builder

LABEL maintainer="Igor Djuric <idjuric@tenstorrent.com>"
LABEL org.opencontainers.image.source=https://github.com/tenstorrent/tt-inference-server

ARG DEBIAN_FRONTEND=noninteractive
# default commit sha, override with --build-arg TT_XLA_COMMIT_SHA_OR_TAG=<sha>
ARG TT_XLA_COMMIT_SHA_OR_TAG=89c1a1ad0ea36a82129b9a94b636b49666ef8941
ARG CONTAINER_APP_UID=1000
ARG TT_SMI_VERSION="latest"

# make build commit SHA available in the image for reference and debugging
ENV TT_XLA_COMMIT_SHA_OR_TAG=${TT_XLA_COMMIT_SHA_OR_TAG}

ENV SHELL=/bin/bash
ENV CONTAINER_APP_USERNAME=container_app_user
ARG HOME_DIR=/home/${CONTAINER_APP_USERNAME}
ENV TT_XLA_HOME=${HOME_DIR}/tt-xla
# tt-metal build vars
ENV TT_METAL_HOME=${TT_XLA_HOME}/third_party/tt-mlir/src/tt-mlir/third_party/tt-metal/src/tt-metal
ENV CONFIG=Release
ENV TT_METAL_ENV=dev
ENV LOGURU_LEVEL=INFO
# derived vars
ENV PYTHONPATH=${TT_XLA_HOME}:/${TT_XLA_HOME}/tests:/usr/local/lib/python3.11/dist-packages:/${TT_XLA_HOME}/integrations/vllm_plugin:/${TT_XLA_HOME}/third_party/tt-mlir/src/tt-mlir/build/python_packages

# apt-get might have an outdated keyring, preventing it to download packages, so we fetch the latest
RUN wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null \
    && echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ focal main' | tee /etc/apt/sources.list.d/kitware.list >/dev/null

# extra system deps - build stage only
RUN apt-get update && apt-get install -y \
    # required for building
    software-properties-common \
    wget \
    git \
    git-lfs \
    python3-pip \
    python3-venv \
    build-essential \
    python3-dev \
    libffi-dev \
    libssl-dev \
    protobuf-compiler \
    libprotobuf-dev \
    pkg-config \
    # build tools
    ninja-build \
    ccache \
    libhwloc-dev \
    libtbb-dev \
    libcapstone-dev \
    patchelf \
    libyaml-cpp-dev \
    libboost-all-dev \
    # utilities for build
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && protoc --version

RUN curl -fsSL https://github.com/Kitware/CMake/releases/download/v3.29.2/cmake-3.29.2-linux-x86_64.sh -o cmake.sh && \
    chmod +x cmake.sh && \
    ./cmake.sh --skip-license --prefix=/usr/local && \
    rm cmake.sh && \
    cmake --version

# user setup
RUN useradd -u ${CONTAINER_APP_UID} -s /bin/bash -d ${HOME_DIR} ${CONTAINER_APP_USERNAME} \
    && mkdir -p ${HOME_DIR} \
    && chown -R ${CONTAINER_APP_USERNAME}:${CONTAINER_APP_USERNAME} ${HOME_DIR}

USER ${CONTAINER_APP_USERNAME}

# build tt-xla
RUN git clone https://github.com/tenstorrent/tt-xla.git ${TT_XLA_HOME} \
    && cd ${TT_XLA_HOME} \
    && git checkout ${TT_XLA_COMMIT_SHA_OR_TAG} \
    && git submodule update --init --recursive \
    && export TTMLIR_TOOLCHAIN_DIR=/opt/ttmlir-toolchain \
    && source ${TT_XLA_HOME}/venv/activate \
    && pip install -e integrations/vllm_plugin --ignore-installed \
    && cmake -G Ninja -B build \
    && cmake --build build

RUN if [ "$TT_SMI_VERSION" = "latest" ] ; then \
    ${TT_XLA_HOME}/venv/bin/pip install tt-smi ; \
else \
    ${TT_XLA_HOME}/venv/bin/pip install "tt-smi==${TT_SMI_VERSION}" ; \
fi


# install inference server requirements
ARG APP_DIR="${HOME_DIR}/app"
COPY --chown=${CONTAINER_APP_USERNAME}:${CONTAINER_APP_USERNAME} "tt-media-server" "${APP_DIR}/server"
COPY --chown=${CONTAINER_APP_USERNAME}:${CONTAINER_APP_USERNAME} "tt-media-server/requirements.txt" "${APP_DIR}/requirements.txt"
RUN cd ${APP_DIR} && ${TT_XLA_HOME}/venv/bin/pip install --default-timeout=240 --no-cache-dir -r requirements.txt || \
    (echo 'Requirements installation failed, trying without pyluwen...' && \
     grep -v pyluwen requirements.txt > requirements_no_pyluwen.txt && \
     ${TT_XLA_HOME}/venv/bin/pip install --default-timeout=240 --no-cache-dir -r requirements_no_pyluwen.txt)

# Cleanup build artifacts to reduce transfer size
USER root
RUN rm -rf ${HOME_DIR}/.cache \
    && rm -rf ${HOME_DIR}/.rustup \
    && rm -rf ${HOME_DIR}/.cargo \
    && rm -rf ${TT_XLA_HOME}/.git \
    && find ${HOME_DIR} -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true \
    && rm -rf ${TT_XLA_HOME}/build/CMakeFiles \
    && rm -rf ${TT_XLA_HOME}/build/_deps \
    && rm -rf ${TT_XLA_HOME}/docs \
    && rm -rf ${TT_XLA_HOME}/tests \
    && rm -rf ${TT_XLA_HOME}/.github \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /usr/include \
    && rm -rf /usr/share/doc \
    && rm -rf /usr/lib/gcc \
    && rm -rf /usr/lib/llvm-14 \
    && rm -rf /usr/share/pocketsphinx \
    && rm -rf /usr/share/vim/vim*/doc \
    && find ${HOME_DIR} -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

# ==============================================================================
# RUNTIME STAGE - final lightweight image
# ==============================================================================
ARG TT_XLA_BASE_IMAGE_TAG="latest"
FROM ghcr.io/tenstorrent/tt-xla/tt-xla-ird-ubuntu-22-04:${TT_XLA_BASE_IMAGE_TAG} AS runtime

LABEL maintainer="Igor Djuric <idjuric@tenstorrent.com>"
LABEL org.opencontainers.image.source=https://github.com/tenstorrent/tt-inference-server

# Reuse all args and environment variables
ARG DEBIAN_FRONTEND=noninteractive
ARG TT_XLA_COMMIT_SHA_OR_TAG=89c1a1ad0ea36a82129b9a94b636b49666ef8941
ARG CONTAINER_APP_UID=1000
ARG CONTAINER_APP_USERNAME=container_app_user
ARG HOME_DIR=/home/${CONTAINER_APP_USERNAME}

ENV TT_XLA_COMMIT_SHA_OR_TAG=${TT_XLA_COMMIT_SHA_OR_TAG} \
    LOG_LEVEL=INFO \
    ENVIRONMENT=development \
    SHELL=/bin/bash \
    CONTAINER_APP_USERNAME=${CONTAINER_APP_USERNAME} \
    TT_XLA_HOME=${HOME_DIR}/tt-xla \
    TT_METAL_HOME=${TT_XLA_HOME}/third_party/tt-mlir/src/tt-mlir/third_party/tt-metal/src/tt-metal \
    CONFIG=Release \
    TT_METAL_ENV=dev \
    LOGURU_LEVEL=INFO \
    PYTHONPATH=${TT_XLA_HOME}:/${TT_XLA_HOME}/tests:/usr/local/lib/python3.11/dist-packages:/${TT_XLA_HOME}/integrations/vllm_plugin:/${TT_XLA_HOME}/third_party/tt-mlir/src/tt-mlir/build/python_packages

# Install only runtime dependencies
RUN apt-get update && apt-get install -y \
    gosu \
    vim \
    curl \
    sudo \
    bash-completion

# Create user
RUN useradd -u ${CONTAINER_APP_UID} -s /bin/bash -d ${HOME_DIR} ${CONTAINER_APP_USERNAME} \
    && mkdir -p ${HOME_DIR} \
    && chown -R ${CONTAINER_APP_USERNAME}:${CONTAINER_APP_USERNAME} ${HOME_DIR}

# Copy everything from builder
COPY --from=builder --chown=${CONTAINER_APP_USERNAME}:${CONTAINER_APP_USERNAME} \
    ${HOME_DIR} ${HOME_DIR}

USER ${CONTAINER_APP_USERNAME}

# Set up bashrc for convenience
RUN echo "source ${TT_XLA_HOME}/venv/activate" >> ${HOME_DIR}/.bashrc

# spinup inference server
ARG APP_DIR="${HOME_DIR}/app"
ENV APP_DIR=${APP_DIR}
WORKDIR ${APP_DIR}

EXPOSE 8000
CMD ["/bin/bash", "-c", "cd ${APP_DIR}/server/ && ${TT_XLA_HOME}/venv/bin/tt-smi -r && ${TT_XLA_HOME}/venv/bin/python -m uvicorn --host 0.0.0.0 main:app --lifespan on --port 8000"]
